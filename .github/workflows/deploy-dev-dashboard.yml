name: Deploy Dev Dashboard

on:
  # Manual trigger only - don't deploy on every push
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  deploy-dev-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'renv'

      - name: Install system dependencies
        run: |
          sudo apt-get install jags libcurl4-openssl-dev \
            libharfbuzz-dev libfribidi-dev libsodium-dev libfontconfig1-dev \
            libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev libcairo2-dev

      - name: Setup dependencies with renv
        uses: r-lib/actions/setup-renv@v2
        with:
          cache-version: 2
        env:
          GITHUB_PAT: ${{ secrets.RENV_GITHUB_PAT }}

      - name: Install plotly (not in renv.lock)
        run: |
          install.packages("plotly")
        shell: Rscript {0}

      - name: Publish dev dashboard to shinyapps.io
        env:
          RSCONNECT_USER: ${{ secrets.RSCONNECT_USER }}
          RSCONNECT_TOKEN: ${{ secrets.RSCONNECT_TOKEN }}
          RSCONNECT_SECRET: ${{ secrets.RSCONNECT_SECRET }}
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        run: |
          rsconnect::setAccountInfo(name = Sys.getenv("RSCONNECT_USER"),
                                    token = Sys.getenv("RSCONNECT_TOKEN"),
                                    secret = Sys.getenv("RSCONNECT_SECRET"))
          quarto::quarto_publish_app(input = "shinyapp/dashboard-dev",
                                     name = "uj-dashboard-dev",
                                     account = "unjournal",
                                     server = "shinyapps.io",
                                     forceUpdate = TRUE)
        shell: Rscript {0}
